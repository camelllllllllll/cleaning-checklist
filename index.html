<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¸…æƒãƒ»æ•´ç†æ•´é “ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</title>
  <style>
    :root {
      --primary:       #2563eb;
      --primary-light: #dbeafe;
      --success:       #16a34a;
      --success-light: #dcfce7;
      --edit:          #d97706;
      --edit-light:    #fef3c7;
      --danger:        #dc2626;
      --danger-light:  #fee2e2;
      --gray-50:  #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
      --radius: 10px;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background: var(--primary);
      color: white;
      padding: 20px 16px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 12px rgba(37,99,235,0.3);
      transition: background 0.25s;
    }
    body.edit-mode header { background: var(--edit); box-shadow: 0 2px 12px rgba(217,119,6,0.3); }

    header h1 { font-size: 1.2rem; font-weight: 700; letter-spacing: 0.03em; }
    header .subtitle { font-size: 0.78rem; opacity: 0.85; margin-top: 2px; }

    .edit-banner {
      display: none;
      margin-top: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.78rem;
      font-weight: 600;
    }
    body.edit-mode .edit-banner { display: block; }

    /* ===== é€²æ—ãƒãƒ¼ ===== */
    .progress-wrap { margin-top: 12px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.78rem; opacity: 0.9; margin-bottom: 5px; }
    .progress-bar-bg { background: rgba(255,255,255,0.3); border-radius: 99px; height: 10px; overflow: hidden; }
    .progress-bar-fill { background: white; height: 100%; border-radius: 99px; transition: width 0.4s ease; }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
    }

    .btn {
      padding: 7px 13px;
      border-radius: 6px;
      border: none;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .btn:hover { opacity: 0.78; }

    .btn-reset  { background: var(--danger-light); color: var(--danger); }
    .btn-all    { background: var(--success-light); color: var(--success); }
    .btn-print  { background: var(--gray-100); color: var(--gray-600); border: 1px solid var(--gray-200); }
    .btn-edit   { background: var(--edit-light); color: var(--edit); }
    .btn-edit.active { background: var(--edit); color: white; }
    .btn-restore { background: var(--gray-100); color: var(--gray-600); border: 1px solid var(--gray-300); display: none; }
    body.edit-mode .btn-restore { display: inline-block; }

    .total-badge {
      margin-left: auto;
      background: var(--primary-light);
      color: var(--primary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    body.edit-mode .total-badge { background: var(--edit-light); color: var(--edit); }

    /* ===== ãƒ¡ã‚¤ãƒ³ ===== */
    main { max-width: 720px; margin: 0 auto; padding: 16px 12px 80px; }

    /* ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
    .section {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
      transition: outline 0.15s;
    }
    body.edit-mode .section { outline: 2px dashed var(--edit-light); }

    .section-header {
      display: flex;
      align-items: center;
      padding: 13px 16px;
      gap: 10px;
      border-bottom: 1px solid var(--gray-100);
    }
    /* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§æŠ˜ã‚Šç•³ã¿ */
    body:not(.edit-mode) .section-header { cursor: pointer; user-select: none; }

    .section-icon { font-size: 1.3rem; line-height: 1; }
    .section-title { font-size: 0.95rem; font-weight: 700; flex: 1; }
    .section-count { font-size: 0.78rem; color: var(--gray-400); font-weight: 600; }
    .section-chevron { font-size: 0.75rem; color: var(--gray-400); transition: transform 0.2s; }
    .section.collapsed .section-chevron { transform: rotate(-90deg); }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨: ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ“ä½œãƒœã‚¿ãƒ³ */
    .section-edit-btns {
      display: none;
      gap: 4px;
    }
    body.edit-mode .section-edit-btns { display: flex; }

    .sec-btn {
      background: none;
      border: 1px solid var(--gray-200);
      border-radius: 5px;
      padding: 3px 7px;
      font-size: 0.72rem;
      cursor: pointer;
      color: var(--gray-600);
      font-weight: 600;
    }
    .sec-btn:hover { background: var(--gray-50); }
    .sec-btn.danger { border-color: #fca5a5; color: var(--danger); }
    .sec-btn.danger:hover { background: var(--danger-light); }

    .task-list { padding: 6px 0; }
    .section.collapsed .task-list { display: none; }

    /* ===== ã‚¿ã‚¹ã‚¯è¡Œ ===== */
    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 16px;
      transition: background 0.15s;
      position: relative;
    }
    body:not(.edit-mode) .task-item { cursor: pointer; }
    body:not(.edit-mode) .task-item:hover { background: var(--gray-50); }

    .task-item.done { background: var(--success-light); }
    .task-item.done .task-name { text-decoration: line-through; color: var(--gray-400); }

    /* ãƒã‚§ãƒƒã‚¯ä¸¸ */
    .task-check {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 2px solid var(--gray-200);
      flex-shrink: 0; margin-top: 1px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem;
      transition: all 0.15s;
    }
    .task-item.done .task-check { background: var(--success); border-color: var(--success); color: white; }
    body.edit-mode .task-check { display: none; }

    .task-info { flex: 1; min-width: 0; }
    .task-name { font-size: 0.9rem; font-weight: 600; line-height: 1.4; }
    .task-note { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; line-height: 1.4; }

    .task-meta { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

    /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ã‚¿ã‚¹ã‚¯æ“ä½œãƒœã‚¿ãƒ³ç¾¤ */
    .task-action-btns {
      display: none;
      flex-direction: column;
      gap: 3px;
      flex-shrink: 0;
    }
    body.edit-mode .task-action-btns { display: flex; }
    body.edit-mode .task-meta { display: none; }

    .task-btn {
      background: none;
      border: 1px solid var(--gray-200);
      border-radius: 5px;
      padding: 3px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      line-height: 1.4;
      white-space: nowrap;
    }
    .task-btn.edit-btn  { color: var(--primary); border-color: var(--primary-light); }
    .task-btn.edit-btn:hover  { background: var(--primary-light); }
    .task-btn.del-btn   { color: var(--danger); border-color: #fca5a5; }
    .task-btn.del-btn:hover   { background: var(--danger-light); }
    .task-btn.up-btn, .task-btn.dn-btn { color: var(--gray-600); font-size: 0.7rem; }
    .task-btn.up-btn:hover, .task-btn.dn-btn:hover { background: var(--gray-100); }

    /* ä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ« */
    .drag-handle {
      display: none;
      cursor: grab;
      color: var(--gray-300);
      font-size: 1.1rem;
      padding: 0 4px;
      align-self: center;
    }
    body.edit-mode .drag-handle { display: block; }

    /* æ‰€è¦æ™‚é–“ãƒãƒƒã‚¸ */
    .time-badge { font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 99px; white-space: nowrap; }
    .time-short { background: #d1fae5; color: #065f46; }
    .time-mid   { background: #fef3c7; color: #92400e; }
    .time-long  { background: #fee2e2; color: #991b1b; }

    /* å„ªå…ˆåº¦ãƒ‰ãƒƒãƒˆ */
    .priority-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .p-high { background: #ef4444; }
    .p-mid  { background: #f59e0b; }
    .p-low  { background: var(--gray-200); }

    /* ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³è¡Œï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰ */
    .add-task-row {
      display: none;
      padding: 8px 16px 12px;
    }
    body.edit-mode .add-task-row { display: block; }

    .add-task-btn {
      width: 100%;
      padding: 8px;
      border: 2px dashed var(--gray-200);
      border-radius: 8px;
      background: none;
      color: var(--gray-400);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .add-task-btn:hover { border-color: var(--edit); color: var(--edit); background: var(--edit-light); }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ */
    .add-section-row {
      display: none;
      padding: 4px 0 16px;
    }
    body.edit-mode .add-section-row { display: block; }

    .add-section-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius);
      background: none;
      color: var(--gray-400);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .add-section-btn:hover { border-color: var(--edit); color: var(--edit); background: var(--edit-light); }

    /* ===== å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
    .complete-msg { text-align: center; padding: 40px 20px; color: var(--success); display: none; }
    .complete-msg.show { display: block; }
    .complete-msg .emoji { font-size: 3rem; }
    .complete-msg p { font-size: 1rem; font-weight: 700; margin-top: 10px; }

    /* ===========================
       ãƒ¢ãƒ¼ãƒ€ãƒ«
    =========================== */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 100;
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: white;
      border-radius: 14px;
      padding: 24px 20px 20px;
      width: 100%; max-width: 460px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      transform: translateY(12px);
      transition: transform 0.2s;
    }
    .modal-overlay.open .modal { transform: translateY(0); }

    .modal-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 18px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-100);
      color: var(--gray-800);
    }

    .form-group { margin-bottom: 14px; }
    .form-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--gray-600);
      margin-bottom: 5px;
    }
    .form-group input[type="text"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 9px 12px;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      font-size: 0.88rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s;
      background: white;
      color: var(--gray-800);
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus { border-color: var(--primary); }
    .form-group textarea { resize: vertical; min-height: 64px; }

    /* ãƒ©ã‚¸ã‚ªé¢¨ãƒœã‚¿ãƒ³ (æ™‚é–“ãƒ»å„ªå…ˆåº¦) */
    .radio-group { display: flex; gap: 6px; flex-wrap: wrap; }
    .radio-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1.5px solid var(--gray-200);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      background: white;
      color: var(--gray-600);
      transition: all 0.12s;
    }
    .radio-btn:hover { border-color: var(--gray-300); }
    .radio-btn.selected { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

    .modal-footer {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }
    .modal-footer .btn { flex: 1; padding: 10px; font-size: 0.88rem; }
    .btn-save   { background: var(--primary); color: white; }
    .btn-save:hover { opacity: 0.88; }
    .btn-cancel { background: var(--gray-100); color: var(--gray-600); }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ã‚¤ã‚³ãƒ³ä¸€è¦§ */
    .icon-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .icon-opt {
      width: 36px; height: 36px;
      border: 1.5px solid var(--gray-200);
      border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.12s;
    }
    .icon-opt:hover { border-color: var(--edit); background: var(--edit-light); }
    .icon-opt.selected { border-color: var(--primary); background: var(--primary-light); }

    /* ===== å°åˆ· ===== */
    @media print {
      header { position: static; background: none; color: black; box-shadow: none; }
      .controls, .add-task-row, .add-section-row, .task-action-btns, .section-edit-btns, .drag-handle { display: none !important; }
      .task-check { display: flex !important; }
      .task-meta { display: flex !important; }
      .section { box-shadow: none; border: 1px solid var(--gray-200); }
      .section.collapsed .task-list { display: block; }
    }

    @media (max-width: 480px) {
      .task-name { font-size: 0.85rem; }
      .section-title { font-size: 0.9rem; }
      .controls { gap: 6px; }
      .btn { padding: 6px 10px; font-size: 0.78rem; }
    }
  </style>
</head>
<body>

<!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
<header>
  <h1>ğŸ§¹ æ¸…æƒãƒ»æ•´ç†æ•´é “ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</h1>
  <p class="subtitle">ç©ºãæ™‚é–“ã«ä¸Šã‹ã‚‰é †ã«å®Ÿæ–½ã—ã¦ãã ã•ã„</p>
  <div class="edit-banner">âœ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ â€• ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ãŒã§ãã¾ã™</div>
  <div class="progress-wrap">
    <div class="progress-label">
      <span>é€²æ—</span>
      <span id="progressText">0 / 0 å®Œäº†</span>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>
</header>

<!-- ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== -->
<div class="controls">
  <button class="btn btn-reset"   onclick="resetAll()">â†º ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="btn btn-all"     onclick="checkAll()">âœ“ å…¨å®Œäº†</button>
  <button class="btn btn-print"   onclick="window.print()">ğŸ–¨ å°åˆ·</button>
  <button class="btn btn-edit"    id="editModeBtn" onclick="toggleEditMode()">âœ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
  <button class="btn btn-restore" onclick="restoreDefaults()">ğŸ”„ åˆæœŸå€¤ã«æˆ»ã™</button>
  <span  class="total-badge"      id="totalBadge">0ä»¶</span>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
<main>
  <div id="taskSections"></div>
  <div class="add-section-row">
    <button class="add-section-btn" onclick="openAddSectionModal()">ï¼‹ ã‚¨ãƒªã‚¢ã‚’è¿½åŠ ã™ã‚‹</button>
  </div>
  <div class="complete-msg" id="completeMsg">
    <div class="emoji">ğŸ‰</div>
    <p>å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</p>
  </div>
</main>

<!-- ===========================
     ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ»è¿½åŠ ï¼‰
=========================== -->
<div class="modal-overlay" id="taskModalOverlay" onclick="onOverlayClick(event,'taskModalOverlay')">
  <div class="modal">
    <div class="modal-title" id="taskModalTitle">ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</div>

    <div class="form-group">
      <label>ã‚¿ã‚¹ã‚¯å <span style="color:#ef4444">*</span></label>
      <input type="text" id="modalName" placeholder="ä¾‹ï¼šçª“ã®ã‚µãƒƒã‚·ã‚’æ‹­ã" maxlength="60" />
    </div>

    <div class="form-group">
      <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
      <textarea id="modalNote" placeholder="ä¾‹ï¼šä¹¾æ‹­ãâ†’æ°´æ‹­ãã§å¯¾å¿œ" maxlength="120"></textarea>
    </div>

    <div class="form-group">
      <label>æ‰€è¦æ™‚é–“</label>
      <div class="radio-group" id="timeGroup">
        <button class="radio-btn" data-val="short" onclick="selectRadio('timeGroup',this)">ã€œ5åˆ†</button>
        <button class="radio-btn" data-val="mid"   onclick="selectRadio('timeGroup',this)">5ã€œ15åˆ†</button>
        <button class="radio-btn" data-val="long"  onclick="selectRadio('timeGroup',this)">15åˆ†ã€œ</button>
      </div>
    </div>

    <div class="form-group">
      <label>å„ªå…ˆåº¦</label>
      <div class="radio-group" id="priorityGroup">
        <button class="radio-btn" data-val="high" onclick="selectRadio('priorityGroup',this)">ğŸ”´ é«˜</button>
        <button class="radio-btn" data-val="mid"  onclick="selectRadio('priorityGroup',this)">ğŸŸ¡ ä¸­</button>
        <button class="radio-btn" data-val="low"  onclick="selectRadio('priorityGroup',this)">âšª ä½</button>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('taskModalOverlay')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-save"   onclick="saveTaskModal()">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¨ãƒªã‚¢ç·¨é›†ãƒ»è¿½åŠ ï¼‰ -->
<div class="modal-overlay" id="sectionModalOverlay" onclick="onOverlayClick(event,'sectionModalOverlay')">
  <div class="modal">
    <div class="modal-title" id="sectionModalTitle">ã‚¨ãƒªã‚¢ã‚’ç·¨é›†</div>

    <div class="form-group">
      <label>ã‚¨ãƒªã‚¢å <span style="color:#ef4444">*</span></label>
      <input type="text" id="secModalName" placeholder="ä¾‹ï¼šãƒˆã‚¤ãƒ¬ãƒ»æ´—é¢æ‰€" maxlength="30" />
    </div>

    <div class="form-group">
      <label>ã‚¢ã‚¤ã‚³ãƒ³</label>
      <div class="icon-grid" id="iconGrid"></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('sectionModalOverlay')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-save"   onclick="saveSectionModal()">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
   time: 'short'(ã€œ5åˆ†) | 'mid'(5ã€œ15åˆ†) | 'long'(15åˆ†ã€œ)
   priority: 'high' | 'mid' | 'low'
============================================================ */
const DEFAULT_SECTIONS = [
  {
    id: 'entrance', icon: 'ğŸšª', title: 'ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ãƒ»å»Šä¸‹',
    tasks: [
      { id:'e1', name:'ãƒ‰ã‚¢ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ã‚’æ‹­ã',         note:'æ±šã‚ŒãŒæºœã¾ã‚Šã‚„ã™ã„ã€‚ä¹¾æ‹­ãâ†’æ°´æ‹­ãã§å¯¾å¿œ',          time:'short', priority:'high' },
      { id:'e2', name:'ãƒ‰ã‚¢ãƒãƒ–ãƒ»å–ã£æ‰‹ã‚’æ‹­ã',        note:'æ¶ˆæ¯’ã‚¹ãƒ—ãƒ¬ãƒ¼ã‚’ä½¿ç”¨',                              time:'short', priority:'high' },
      { id:'e3', name:'å‚˜ç«‹ã¦å‘¨è¾ºã‚’æ•´ç†ã™ã‚‹',           note:'å£Šã‚ŒãŸå‚˜ãƒ»å¿˜ã‚Œç‰©ã®å‚˜ã‚’ç¢ºèª',                      time:'short', priority:'mid'  },
      { id:'e4', name:'æ²ç¤ºç‰©ãƒ»è²¼ã‚Šç´™ã®ã¯ãŒã‚Œã‚’ç¢ºèª',  note:'æµ®ã„ã¦ã„ã‚‹ã‚‚ã®ã¯ãƒ†ãƒ¼ãƒ—ã§è£œå¼·',                      time:'short', priority:'low'  },
      { id:'e5', name:'å»Šä¸‹ã®éš…ãƒ»å¹…æœ¨ã‚’æ‹­ã',          note:'è¦‹è½ã¨ã•ã‚Œã‚„ã™ã„åŸƒã‚¹ãƒãƒƒãƒˆ',                        time:'mid',   priority:'mid'  },
    ]
  },
  {
    id: 'classroom', icon: 'ğŸ“š', title: 'æ•™å®¤å†…ï¼ˆæœºãƒ»æ£šãƒ»å‚™å“ï¼‰',
    tasks: [
      { id:'c1', name:'è½ã¨ã—ç‰©ã‚’ä¸€ã‹æ‰€ã«ã¾ã¨ã‚ã‚‹',    note:'æ–‡å…·ãƒ»æ¶ˆã—ã‚´ãƒ ãƒ»å®šè¦ãªã©ã€‚æ‰€å®šã®å ´æ‰€ã¸',           time:'short', priority:'high' },
      { id:'c2', name:'èµ¤æœ¬ï¼ˆéå»å•ï¼‰ã‚’æ•´ç†ã™ã‚‹',       note:'ç§‘ç›®ãƒ»å­¦æ ¡åˆ¥ã«ä¸¦ã¹ç›´ã—ã€‚èƒŒè¡¨ç´™ãŒè¦‹ãˆã‚‹ã‚ˆã†æƒãˆã‚‹', time:'mid',   priority:'high' },
      { id:'c3', name:'æœ¬æ£šã®æ‹­ãæƒé™¤ã‚’ã™ã‚‹',           note:'æ£šæ¿ãƒ»å´é¢ã®åŸƒã‚’æ‹­ãå–ã‚‹',                        time:'mid',   priority:'high' },
      { id:'c4', name:'å‚è€ƒæ›¸ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã®ä¸¦ã³ã‚’æ•´ãˆã‚‹', note:'ãƒãƒ©ãƒãƒ©ã®ã‚‚ã®ã‚’ã‚·ãƒªãƒ¼ã‚ºãƒ»ç§‘ç›®é †ã«æƒãˆã‚‹',          time:'mid',   priority:'mid'  },
      { id:'c5', name:'æœºã®å¤©æ¿ãƒ»å¼•ãå‡ºã—å‰é¢ã‚’æ‹­ã',   note:'æ¶ˆã—ã‚«ã‚¹ãƒ»é£²ã¿ç‰©ã®è·¡ã‚’ãƒã‚§ãƒƒã‚¯',                  time:'mid',   priority:'mid'  },
      { id:'c6', name:'æ¤…å­ã®åº§é¢ãƒ»èƒŒé¢ã‚’æ‹­ã',         note:'å¸ƒåœ°ã®å ´åˆã¯ç²˜ç€ãƒ†ãƒ¼ãƒ—ã§åŸƒã‚’å–ã‚‹',                time:'mid',   priority:'low'  },
      { id:'c7', name:'æœºãƒ»æ¤…å­ã®è„šã®æ±šã‚Œã‚’æ‹­ã',       note:'åºŠã¨ã®æ¥åœ°éƒ¨åˆ†ã«æ±šã‚ŒãŒæºœã¾ã‚Šã‚„ã™ã„',              time:'long',  priority:'low'  },
    ]
  },
  {
    id: 'pc', icon: 'ğŸ’»', title: 'ãƒ‘ã‚½ã‚³ãƒ³ãƒ»é›»å­æ©Ÿå™¨',
    tasks: [
      { id:'p1', name:'ãƒ‘ã‚½ã‚³ãƒ³ç”»é¢ã‚’æ‹­ã',              note:'å°‚ç”¨ã‚¯ãƒ­ã‚¹ä½¿ç”¨ã€‚å¼·ãæŠ¼ã•ãªã„',                   time:'short', priority:'high' },
      { id:'p2', name:'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æ‹­ã',                 note:'ã‚­ãƒ¼ã®éš™é–“ã¯ã‚¨ã‚¢ãƒ€ã‚¹ã‚¿ãƒ¼ã¾ãŸã¯ç¶¿æ£’',             time:'short', priority:'high' },
      { id:'p3', name:'ãƒã‚¦ã‚¹ãƒ»ãƒã‚¦ã‚¹ãƒ‘ãƒƒãƒ‰ã‚’æ‹­ã',       note:'ãƒã‚¦ã‚¹åº•é¢ï¼ˆã‚»ãƒ³ã‚µãƒ¼å‘¨ã‚Šï¼‰ã‚‚å¿˜ã‚Œãšã«',           time:'short', priority:'mid'  },
      { id:'p4', name:'PCãƒ‡ã‚¹ã‚¯å‘¨è¾ºã®ã‚±ãƒ¼ãƒ–ãƒ«ã‚’æ•´ãˆã‚‹',   note:'æŸã­ã¦ã‚±ãƒ¼ãƒ–ãƒ«ãƒœãƒƒã‚¯ã‚¹ã¸ã€‚åºŠã®ã‚±ãƒ¼ãƒ–ãƒ«ã‚‚ç¢ºèª',   time:'mid',   priority:'low'  },
      { id:'p5', name:'ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãƒ»ã‚³ãƒ”ãƒ¼æ©Ÿå‘¨è¾ºã‚’æ‹­ã',   note:'ãƒˆãƒ¬ã‚¤ã«ç´™ããšãƒ»åŸƒãŒãªã„ã‹ç¢ºèª',                 time:'short', priority:'low'  },
    ]
  },
  {
    id: 'whiteboard', icon: 'âœï¸', title: 'ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ãƒ»é»’æ¿',
    tasks: [
      { id:'w1', name:'ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã‚’æ¶ˆã—ã¦æ‹­ã',       note:'æ¶ˆã—ã‚«ã‚¹ã‚’æ‰•ã„ã€ã‚¯ãƒªãƒ¼ãƒŠãƒ¼ã§ç£¨ã',              time:'short', priority:'high' },
      { id:'w2', name:'ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ãƒãƒ¼ã‚«ãƒ¼ã‚’æ•´ç†ã™ã‚‹', note:'ã‚­ãƒ£ãƒƒãƒ—ãŒå¤–ã‚ŒãŸã‚‚ã®ã‚’ç¢ºèªã€‚ä½¿ãˆãªã„ãƒãƒ¼ã‚«ãƒ¼ã‚’å‡¦åˆ†', time:'short', priority:'mid' },
      { id:'w3', name:'ã‚¤ãƒ¬ãƒ¼ã‚¶ãƒ¼ã®åŸƒã‚’æ‰•ã†',             note:'å±‹å¤–ã§ãƒ‘ãƒ³ãƒ‘ãƒ³ã¨å©ã',                          time:'short', priority:'low'  },
      { id:'w4', name:'é»’æ¿ãƒ»ãƒœãƒ¼ãƒ‰æ ã®æºã‚’æ‹­ã',         note:'ãƒãƒ§ãƒ¼ã‚¯ãƒ»ãƒãƒ¼ã‚«ãƒ¼ã®ç²‰ãŒæºœã¾ã‚Šã‚„ã™ã„',           time:'short', priority:'mid'  },
    ]
  },
  {
    id: 'common', icon: 'ğŸ ', title: 'å…±ç”¨ã‚¹ãƒšãƒ¼ã‚¹ãƒ»å—ä»˜',
    tasks: [
      { id:'k1', name:'å—ä»˜ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ‹­ã',             note:'è¡¨é¢ãƒ»å¼•ãå‡ºã—å‰é¢ãƒ»è¶³å…ƒã¾ã§',                  time:'short', priority:'high' },
      { id:'k2', name:'ç…§æ˜ã‚¹ã‚¤ãƒƒãƒå‘¨ã‚Šã‚’æ‹­ã',           note:'æ‰‹ãŒè§¦ã‚Œã‚‹éƒ¨åˆ†ã¯é»’ãšã¿ã‚„ã™ã„',                  time:'short', priority:'mid'  },
      { id:'k3', name:'ã‚´ãƒŸç®±ã®ä¸­ã‚’ç¢ºèªãƒ»ã‚´ãƒŸã‚’æ¨ã¦ã‚‹',  note:'æº€æ¯ã¾ãŸã¯è‡­ã„ãŒã‚ã‚‹å ´åˆã¯äº¤æ›',                 time:'short', priority:'high' },
      { id:'k4', name:'é›»æºã‚¿ãƒƒãƒ—ãƒ»ã‚³ãƒ³ã‚»ãƒ³ãƒˆå‘¨ã‚Šã‚’æ‹­ã', note:'åŸƒã¯ã‚·ãƒ§ãƒ¼ãƒˆã®åŸå› ã«ãªã‚‹',                      time:'short', priority:'mid'  },
      { id:'k5', name:'çª“ã®ã‚µãƒƒã‚·ãƒ»æ¡Ÿã‚’æ‹­ã',             note:'é›‘å·¾ã‚’ç´°ãæŠ˜ã£ã¦æºã«å½“ã¦ã‚‹',                    time:'mid',   priority:'low'  },
      { id:'k6', name:'ã‚¨ã‚¢ã‚³ãƒ³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç¢ºèªã™ã‚‹',   note:'åŸƒãŒå¤šã„å ´åˆã¯å¤–ã—ã¦æƒé™¤æ©Ÿã‚’ã‹ã‘ã‚‹',             time:'long',  priority:'low'  },
    ]
  },
  {
    id: 'floor', icon: 'ğŸ§º', title: 'åºŠãƒ»å…¨ä½“',
    tasks: [
      { id:'f1', name:'ç›®ã«è¦‹ãˆã‚‹ã‚´ãƒŸãƒ»ç´™ããšã‚’æ‹¾ã†',    note:'ç‰¹ã«æœºã®ä¸‹ãƒ»æœ¬æ£šã®å¥¥',                           time:'short', priority:'high' },
      { id:'f2', name:'åºŠã‚’æƒãæƒé™¤ã™ã‚‹ï¼ˆã»ã†ãï¼‰',      note:'ç«¯ã‹ã‚‰ä¸­å¤®ã¸æƒãã€‚æœºã®ä¸‹ã‚‚ã—ã£ã‹ã‚Š',              time:'mid',   priority:'mid'  },
      { id:'f3', name:'ãƒ¢ãƒƒãƒ—ãŒã‘ã‚’ã™ã‚‹',                 note:'æ°´ã¯å›ºãçµã‚‹ã€‚ã‚³ãƒ³ã‚»ãƒ³ãƒˆå‘¨è¾ºã¯é¿ã‘ã‚‹',            time:'long',  priority:'low'  },
    ]
  },
];

const ICON_OPTIONS = ['ğŸšª','ğŸ“š','ğŸ’»','âœï¸','ğŸ ','ğŸ§º','ğŸª£','ğŸ›','ğŸš½','ğŸ³','ğŸ“¦','ğŸ—‚ï¸','ğŸ–¨ï¸','ğŸ’','ğŸ“‹','ğŸ§¹','ğŸª´','ğŸ”‘','ğŸ’¡','ğŸ–¥ï¸'];

/* ============================================================
   ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
============================================================ */
const DATA_KEY  = 'cleaning_tasks_v2';
const CHECK_KEY = 'cleaning_checks_v2';

function deepClone(o)   { return JSON.parse(JSON.stringify(o)); }

function loadSections()  {
  try { const s = localStorage.getItem(DATA_KEY);  if (s) return JSON.parse(s); } catch {}
  return deepClone(DEFAULT_SECTIONS);
}
function saveSections()  { localStorage.setItem(DATA_KEY,  JSON.stringify(sectionsData)); }

function loadChecks()    {
  try { return JSON.parse(localStorage.getItem(CHECK_KEY)) || {}; } catch { return {}; }
}
function saveChecks()    { localStorage.setItem(CHECK_KEY, JSON.stringify(checkState)); }

let sectionsData = loadSections();
let checkState   = loadChecks();
let editMode     = false;

/* ============================================================
   ãƒ¦ãƒ‹ãƒ¼ã‚¯ ID ç”Ÿæˆ
============================================================ */
function uid() { return 't' + Date.now() + Math.random().toString(36).slice(2,6); }

/* ============================================================
   ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
============================================================ */
function timeBadge(t) {
  const map = { short:{cls:'time-short',label:'ã€œ5åˆ†'}, mid:{cls:'time-mid',label:'5ã€œ15åˆ†'}, long:{cls:'time-long',label:'15åˆ†ã€œ'} };
  const m = map[t] || map.short;
  return `<span class="time-badge ${m.cls}">${m.label}</span>`;
}
function priorityDot(p) {
  const cls = p==='high'?'p-high':p==='mid'?'p-mid':'p-low';
  const lbl = p==='high'?'å„ªå…ˆåº¦ï¼šé«˜':p==='mid'?'å„ªå…ˆåº¦ï¼šä¸­':'å„ªå…ˆåº¦ï¼šä½';
  return `<span class="priority-dot ${cls}" title="${lbl}"></span>`;
}

function renderSections() {
  const container = document.getElementById('taskSections');
  container.innerHTML = '';

  sectionsData.forEach((section, si) => {
    const doneCount = section.tasks.filter(t => checkState[t.id]).length;
    const total     = section.tasks.length;
    const isCollapsed = !editMode && doneCount === total && total > 0;

    // ã‚¿ã‚¹ã‚¯è¡Œ
    const tasksHtml = section.tasks.map((task, ti) => {
      const done = !!checkState[task.id];
      return `
        <div class="task-item ${done?'done':''}"
             data-sid="${section.id}" data-tid="${task.id}"
             onclick="onTaskClick(event,'${section.id}','${task.id}')">
          <span class="drag-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ">â ¿</span>
          <div class="task-check">${done?'âœ“':''}</div>
          <div class="task-info">
            <div class="task-name">${esc(task.name)}</div>
            ${task.note ? `<div class="task-note">${esc(task.note)}</div>` : ''}
          </div>
          <div class="task-meta">
            ${timeBadge(task.time)}
            ${priorityDot(task.priority)}
          </div>
          <div class="task-action-btns">
            <button class="task-btn edit-btn" onclick="openEditTaskModal(event,'${section.id}','${task.id}')">âœ ç·¨é›†</button>
            <button class="task-btn del-btn"  onclick="deleteTask(event,'${section.id}','${task.id}')">âœ• å‰Šé™¤</button>
            ${ti > 0
              ? `<button class="task-btn up-btn" onclick="moveTask(event,'${section.id}','${task.id}',-1)">â–²</button>`
              : `<button class="task-btn up-btn" style="opacity:.25;pointer-events:none">â–²</button>`}
            ${ti < section.tasks.length-1
              ? `<button class="task-btn dn-btn" onclick="moveTask(event,'${section.id}','${task.id}',1)">â–¼</button>`
              : `<button class="task-btn dn-btn" style="opacity:.25;pointer-events:none">â–¼</button>`}
          </div>
        </div>`;
    }).join('');

    const el = document.createElement('div');
    el.className = `section${isCollapsed?' collapsed':''}`;
    el.id = `section-${section.id}`;
    el.innerHTML = `
      <div class="section-header"
           onclick="onSectionHeaderClick(event,'${section.id}')">
        <span class="section-icon">${section.icon}</span>
        <span class="section-title">${esc(section.title)}</span>
        <span class="section-count">${doneCount}/${total}</span>
        <div class="section-edit-btns" onclick="event.stopPropagation()">
          <button class="sec-btn" onclick="openEditSectionModal('${section.id}')">âœ ç·¨é›†</button>
          ${si > 0
            ? `<button class="sec-btn" onclick="moveSection('${section.id}',-1)">â–²</button>`
            : `<button class="sec-btn" style="opacity:.25;pointer-events:none">â–²</button>`}
          ${si < sectionsData.length-1
            ? `<button class="sec-btn" onclick="moveSection('${section.id}',1)">â–¼</button>`
            : `<button class="sec-btn" style="opacity:.25;pointer-events:none">â–¼</button>`}
          <button class="sec-btn danger" onclick="deleteSection('${section.id}')">âœ• å‰Šé™¤</button>
        </div>
        <span class="section-chevron">â–¼</span>
      </div>
      <div class="task-list">${tasksHtml}</div>
      <div class="add-task-row">
        <button class="add-task-btn" onclick="openAddTaskModal('${section.id}')">ï¼‹ ã“ã®ã‚¨ãƒªã‚¢ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
      </div>`;
    container.appendChild(el);
  });

  updateProgress();
}

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ============================================================
   é€²æ—ãƒãƒ¼
============================================================ */
function updateProgress() {
  const allTasks = sectionsData.flatMap(s => s.tasks);
  const total    = allTasks.length;
  const done     = allTasks.filter(t => checkState[t.id]).length;
  const pct      = total ? Math.round((done/total)*100) : 0;

  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${done} / ${total} å®Œäº†ï¼ˆ${pct}%ï¼‰`;
  document.getElementById('totalBadge').textContent   = `å…¨${total}ä»¶`;

  const msg = document.getElementById('completeMsg');
  msg.classList.toggle('show', !editMode && done===total && total>0);
}

/* ============================================================
   ãƒã‚§ãƒƒã‚¯æ“ä½œ
============================================================ */
function onTaskClick(e, sid, tid) {
  if (editMode) return;
  checkState[tid] = !checkState[tid];
  saveChecks();
  renderSections();
}

/* ============================================================
   ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚Šç•³ã¿
============================================================ */
function onSectionHeaderClick(e, sid) {
  if (editMode) return;
  const el = document.getElementById(`section-${sid}`);
  el.classList.toggle('collapsed');
}

/* ============================================================
   ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
============================================================ */
function toggleEditMode() {
  editMode = !editMode;
  document.body.classList.toggle('edit-mode', editMode);
  const btn = document.getElementById('editModeBtn');
  btn.classList.toggle('active', editMode);
  btn.textContent = editMode ? 'âœ” ç·¨é›†ã‚’çµ‚äº†' : 'âœ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
  renderSections();
}

/* ============================================================
   åˆæœŸå€¤ã«æˆ»ã™
============================================================ */
function restoreDefaults() {
  if (!confirm('ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼‰')) return;
  sectionsData = deepClone(DEFAULT_SECTIONS);
  checkState   = {};
  saveSections();
  saveChecks();
  renderSections();
}

/* ============================================================
   ãƒã‚§ãƒƒã‚¯å…¨ãƒªã‚»ãƒƒãƒˆ / å…¨å®Œäº†
============================================================ */
function resetAll() {
  if (!confirm('å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  checkState = {};
  saveChecks();
  renderSections();
}
function checkAll() {
  if (!confirm('å…¨ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  sectionsData.forEach(s => s.tasks.forEach(t => { checkState[t.id] = true; }));
  saveChecks();
  renderSections();
}

/* ============================================================
   ã‚¿ã‚¹ã‚¯: ç§»å‹•ãƒ»å‰Šé™¤
============================================================ */
function moveTask(e, sid, tid, dir) {
  e.stopPropagation();
  const sec = sectionsData.find(s => s.id === sid);
  if (!sec) return;
  const i = sec.tasks.findIndex(t => t.id === tid);
  const j = i + dir;
  if (j < 0 || j >= sec.tasks.length) return;
  [sec.tasks[i], sec.tasks[j]] = [sec.tasks[j], sec.tasks[i]];
  saveSections();
  renderSections();
}

function deleteTask(e, sid, tid) {
  e.stopPropagation();
  const sec = sectionsData.find(s => s.id === sid);
  if (!sec) return;
  const task = sec.tasks.find(t => t.id === tid);
  if (!task) return;
  if (!confirm(`ã€Œ${task.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  sec.tasks = sec.tasks.filter(t => t.id !== tid);
  delete checkState[tid];
  saveSections();
  saveChecks();
  renderSections();
}

/* ============================================================
   ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ç§»å‹•ãƒ»å‰Šé™¤
============================================================ */
function moveSection(sid, dir) {
  const i = sectionsData.findIndex(s => s.id === sid);
  const j = i + dir;
  if (j < 0 || j >= sectionsData.length) return;
  [sectionsData[i], sectionsData[j]] = [sectionsData[j], sectionsData[i]];
  saveSections();
  renderSections();
}

function deleteSection(sid) {
  const sec = sectionsData.find(s => s.id === sid);
  if (!sec) return;
  const msg = sec.tasks.length > 0
    ? `ã€Œ${sec.title}ã€ã¨ãã®ä¸­ã® ${sec.tasks.length} ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
    : `ã€Œ${sec.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
  if (!confirm(msg)) return;
  sec.tasks.forEach(t => delete checkState[t.id]);
  sectionsData = sectionsData.filter(s => s.id !== sid);
  saveSections();
  saveChecks();
  renderSections();
}

/* ============================================================
   ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š
============================================================ */
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function onOverlayClick(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }

function selectRadio(groupId, btn) {
  document.querySelectorAll(`#${groupId} .radio-btn`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}
function getRadio(groupId) {
  const sel = document.querySelector(`#${groupId} .radio-btn.selected`);
  return sel ? sel.dataset.val : null;
}
function setRadio(groupId, val) {
  document.querySelectorAll(`#${groupId} .radio-btn`).forEach(b => {
    b.classList.toggle('selected', b.dataset.val === val);
  });
}

/* ============================================================
   ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
============================================================ */
let _taskModal = { sid: null, tid: null }; // ç·¨é›†ä¸­ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

function openAddTaskModal(sid) {
  _taskModal = { sid, tid: null };
  document.getElementById('taskModalTitle').textContent = 'ï¼‹ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ';
  document.getElementById('modalName').value = '';
  document.getElementById('modalNote').value = '';
  setRadio('timeGroup', 'short');
  setRadio('priorityGroup', 'mid');
  openModal('taskModalOverlay');
  setTimeout(() => document.getElementById('modalName').focus(), 100);
}

function openEditTaskModal(e, sid, tid) {
  e.stopPropagation();
  const sec  = sectionsData.find(s => s.id === sid);
  const task = sec && sec.tasks.find(t => t.id === tid);
  if (!task) return;

  _taskModal = { sid, tid };
  document.getElementById('taskModalTitle').textContent = 'âœ ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
  document.getElementById('modalName').value = task.name;
  document.getElementById('modalNote').value = task.note || '';
  setRadio('timeGroup',     task.time     || 'short');
  setRadio('priorityGroup', task.priority || 'mid');
  openModal('taskModalOverlay');
  setTimeout(() => document.getElementById('modalName').focus(), 100);
}

function saveTaskModal() {
  const name = document.getElementById('modalName').value.trim();
  if (!name) { alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const payload = {
    name,
    note:     document.getElementById('modalNote').value.trim(),
    time:     getRadio('timeGroup')     || 'short',
    priority: getRadio('priorityGroup') || 'mid',
  };

  const sec = sectionsData.find(s => s.id === _taskModal.sid);
  if (!sec) return;

  if (_taskModal.tid) {
    // ç·¨é›†
    const task = sec.tasks.find(t => t.id === _taskModal.tid);
    if (task) Object.assign(task, payload);
  } else {
    // è¿½åŠ 
    sec.tasks.push({ id: uid(), ...payload });
  }

  saveSections();
  renderSections();
  closeModal('taskModalOverlay');
}

/* ============================================================
   ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
============================================================ */
let _secModal = { sid: null };

function buildIconGrid(selected) {
  const grid = document.getElementById('iconGrid');
  grid.innerHTML = ICON_OPTIONS.map(ic =>
    `<div class="icon-opt${ic===selected?' selected':''}" onclick="selectIcon(this,'${ic}')">${ic}</div>`
  ).join('');
}
function selectIcon(el, icon) {
  document.querySelectorAll('.icon-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}
function getSelectedIcon() {
  const el = document.querySelector('.icon-opt.selected');
  return el ? el.textContent : 'ğŸ“‹';
}

function openEditSectionModal(sid) {
  const sec = sectionsData.find(s => s.id === sid);
  if (!sec) return;
  _secModal = { sid };
  document.getElementById('sectionModalTitle').textContent = 'âœ ã‚¨ãƒªã‚¢ã‚’ç·¨é›†';
  document.getElementById('secModalName').value = sec.title;
  buildIconGrid(sec.icon);
  openModal('sectionModalOverlay');
  setTimeout(() => document.getElementById('secModalName').focus(), 100);
}

function openAddSectionModal() {
  _secModal = { sid: null };
  document.getElementById('sectionModalTitle').textContent = 'ï¼‹ ã‚¨ãƒªã‚¢ã‚’è¿½åŠ ';
  document.getElementById('secModalName').value = '';
  buildIconGrid('ğŸ“‹');
  openModal('sectionModalOverlay');
  setTimeout(() => document.getElementById('secModalName').focus(), 100);
}

function saveSectionModal() {
  const name = document.getElementById('secModalName').value.trim();
  if (!name) { alert('ã‚¨ãƒªã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const icon = getSelectedIcon();

  if (_secModal.sid) {
    const sec = sectionsData.find(s => s.id === _secModal.sid);
    if (sec) { sec.title = name; sec.icon = icon; }
  } else {
    sectionsData.push({ id: uid(), icon, title: name, tasks: [] });
  }

  saveSections();
  renderSections();
  closeModal('sectionModalOverlay');
}

/* ============================================================
   Enterã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ä¿å­˜
============================================================ */
document.getElementById('modalName').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveTaskModal();
});
document.getElementById('secModalName').addEventListener('keydown', e => {
  if (e.key === 'Enter') saveSectionModal();
});

/* ============================================================
   åˆæœŸåŒ–
============================================================ */
renderSections();
</script>
</body>
</html>
